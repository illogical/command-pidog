version: '3.8'

services:
  # Tailscale service — exposes the FastAPI server via HTTPS on the Tailscale network
  tailscale:
    image: ghcr.io/tailscale/tailscale:latest
    container_name: ts-command-pidog-api
    hostname: command-pidog-api # Advertised hostname on Tailscale; API reachable at https://command-pidog-api.<tailnet>.ts.net
    environment:
      # Tailscale authentication key
      # REQUIRED: Set this in a .env file or directly in your environment.
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      # Tells Tailscale where to store its state data within the container.
      - TS_STATE_DIR=/var/lib/tailscale
      # HTTPS configuration for Tailscale Serve (proxies to FastAPI on the Pi host)
      - TS_SERVE_CONFIG=/config/https.json
      - TS_USERSPACE=false
    volumes:
      # Mounts a local directory for Tailscale configuration files
      - ${PWD}/config:/config
      # Mounts a named Docker volume to persist Tailscale state across container restarts.
      - tailscale_state:/var/lib/tailscale
      # Required for Tailscale to create the tunnel interface.
      - /dev/net/tun:/dev/net/tun
    cap_add:
      # Required for Tailscale to manage network interfaces and routing.
      - NET_ADMIN
      - SYS_MODULE
    extra_hosts:
      # Allows the Tailscale container to reach the Pi host's network.
      # FastAPI runs directly on the Pi (not in Docker) at port 8000, so we
      # resolve host.docker.internal → Docker bridge gateway → Pi host loopback.
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

# Named volume to persist Tailscale state
volumes:
  tailscale_state: {}
